---
import { Image, getImage } from 'astro:assets';
import type { ImageMetadata } from 'astro:assets';

interface Festival {
  name: string;
  start: string;
  end:   string;
  logo?:  string;
  images?: { src: string; title?: string; desc?: string }[];
  video?:  string;
  link?: { url: string; text: string };
  bg?:     string;
  text?:   string;
  description: string;
  country:   string;
  sponsor?: string;
}

const { festivals }:{ festivals: Festival[] } = Astro.props;

// 1. Load ALL images in src/assets
const allImages = import.meta.glob<{ default: ImageMetadata }>('/src/assets/**/*.{jpeg,jpg,png,gif,webp}', { eager: true });
const sponsorLogos = import.meta.glob<{ default: ImageMetadata }>('/src/assets/sponsors/*.{jpeg,jpg,png,gif,webp,svg}', { eager: true });

function slugify(str: string) {
  return str.toLowerCase().replace(/[^\w\s-]/g, '').trim().replace(/\s+/g, '-');
}

function formatTitleFromFilename(path: string) {
  const fileName = path.split('/').pop()?.split('.')[0] || '';
  return fileName.replace(/_/g, ' '); 
}

/* Sort chronologically */
festivals.sort((a, b) => new Date(a.start).valueOf() - new Date(b.start).valueOf());

/* PRE-PROCESSING: 
   We iterate here with await to generate optimized lightbox images 
   before rendering the HTML.
*/
const processedFestivals = await Promise.all(festivals.map(async (f) => {
  const bg   = f.bg   || '#f3f4f6';
  const text = f.text || 'inherit';

  const sponsorImagePath = f.sponsor ? `/src/assets/${f.sponsor}` : null;
  const sponsorImageModule = sponsorImagePath ? sponsorLogos[sponsorImagePath] : null;

  // Process Images Logic
  const galleryItems: { type: 'astro' | 'standard', src: any, fullResSrc: string, title: string }[] = [];

  if (f.images) {
    for (const entry of f.images) {
      const cleanPath = '/' + entry.src.replace(/^(\.\.\/)+/, '').replace(/^\//, '');
      const matchingKeys = Object.keys(allImages).filter(key => key.startsWith(cleanPath));

      if (matchingKeys.length > 0) {
        matchingKeys.sort();
        for (const key of matchingKeys) {
          const isSingleFile = (key === cleanPath);
          const autoTitle = formatTitleFromFilename(key);
          const finalTitle = (isSingleFile && entry.title) ? entry.title : autoTitle;
          const originalImg = allImages[key].default;

          // OPTIMIZATION: Generate a high-quality WebP for the Lightbox
          const optimizedFull = await getImage({
            src: originalImg,
            format: 'webp',
            width: 1600, // Limit max width to 1600px for speed
            quality: 85
          });

          galleryItems.push({
            type: 'astro',
            src: originalImg, // Thumbnail (Astro handles resizing)
            fullResSrc: optimizedFull.src, // Optimized Lightbox URL
            title: finalTitle
          });
        }
      } else {
        // Standard external images
        galleryItems.push({
          type: 'standard',
          src: entry.src,
          fullResSrc: entry.src,
          title: entry.title || ''
        });
      }
    }
  }

  return { ...f, bg, text, sponsorImageModule, galleryItems };
}));
---

<ul class="timeline-wrapper">
  {processedFestivals.map((f, festivalIdx) => {
    return (
      <li id={slugify(f.name)} class="timeline-item">
        <span class="timeline-connector"></span>
        <span class="timeline-branch-circle"></span>

        <div class="timeline-card" style={`background-color:${f.bg}; color:${f.text}`}>
          
          {/* HEADER */}
          <div class="flex items-center gap-4 mb-2">
            {f.logo && (
               <Image
                 src={`/src/assets/${f.logo}`}
                 alt={`${f.name} logo`}
                 width={56} height={56}
                 class="object-contain shrink-0"
               />
            )}
            <div>
              <h3 class="text-lg font-semibold leading-tight">{f.name}</h3>
              <p class="text-sm opacity-80">
                {new Date(f.start).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })}
                &nbsp;–&nbsp;
                {new Date(f.end).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}
              </p>
            </div>
          </div>

          {/* BODY */}
          <div class="flex flex-col sm:flex-row gap-4">
            
            {/* GALLERY */}
            {f.galleryItems.length > 0 && (
              <div
                class="gallery flex-shrink-0 w-full h-[150px] sm:w-[30%] sm:self-stretch sm:h-auto rounded-md overflow-hidden sm:overflow-y-auto"
                data-festival-index={festivalIdx}
                style={`--card-bg: ${f.bg};`}
              >
                <div class="flex flex-row sm:flex-col gap-2 p-1 h-full w-full overflow-x-auto sm:overflow-x-hidden sm:overflow-y-auto snap-x sm:snap-y snap-mandatory">
                  
                  {f.galleryItems.map((item, i) => {
                    return (
                    <div key={i} class="relative flex-none h-full w-auto sm:w-full sm:h-auto snap-center group">
                      {item.type === 'astro' ? (
                        <Image
                          src={item.src}
                          alt={item.title}
                          width={600}
                          densities={[1.5, 2]}
                          class="flex-none rounded-md cursor-pointer h-full w-auto object-contain sm:w-full sm:h-auto sm:object-cover"
                          data-title={item.title}
                          data-index={i}
                          data-full-src={item.fullResSrc} 
                        />
                      ) : (
                        <img
                          src={item.src} 
                          alt={item.title}
                          class="flex-none rounded-md cursor-pointer h-full w-auto object-contain sm:w-full sm:h-auto sm:object-cover"
                          data-title={item.title}
                          data-index={i}
                          data-full-src={item.fullResSrc}
                          loading="lazy"
                        />
                      )}
                      <div class="absolute inset-0 bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center rounded-md pointer-events-none">
                        <span class="text-white text-sm px-2 text-center">{item.title}</span>
                      </div>
                    </div>
                  )})}
                </div>
              </div>
            )}

            {/* TEXT / VIDEO */}
            <div class={`timeline-text flex-1 min-h-0 ${f.galleryItems.length ? 'sm:pl-1' : ''}`}>
              <p class="text-justify whitespace-pre-line">{f.description}</p>
              
              {f.sponsorImageModule && (
                <div class="mt-4 border-t border-dashed border-gray-400 pt-4 flex justify-center">
                  <Image
                    src={f.sponsorImageModule.default}
                    alt={`${f.name} sponsor logo`}
                    width={150} height={100}
                    class="object-contain"
                  />
                </div>
              )}

              {f.video && (
                <div class="mt-4">
                  <iframe
                    src={f.video}
                    title={`Video coverage of ${f.name}`}
                    loading="lazy"
                    class="w-full aspect-video rounded-md"
                    allow="accelerometer; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen
                  />
                </div>
              )}

              {f.link && (
                <div class="mt-4 text-center">
                  <a
                    href={f.link.url}
                    class="inline-flex items-center gap-2 text-lg font-bold text-gray-500 hover:text-gray-600 underline-offset-4 hover:underline"
                  >
                    {f.link.text}
                    <span aria-hidden="true" class="text-xl">↗︎</span>
                  </a>
                </div>
              )}
            </div>
          </div>
        </div>
      </li>
    );
  })}
</ul>

{/* LIGHTBOX HTML */}
<div id="lightbox" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden flex items-center justify-center p-4">
  <button id="lightbox-close" class="absolute top-4 right-4 text-white text-2xl font-bold focus:outline-none" aria-label="Close">&times;</button>
  <button id="lightbox-prev" class="absolute left-4 top-1/2 transform -translate-y-1/2 p-4 focus:outline-none" aria-label="Previous Image"><span class="text-white text-3xl">&#10094;</span></button>
  <button id="lightbox-next" class="absolute right-4 top-1/2 transform -translate-y-1/2 p-4 focus:outline-none" aria-label="Next Image"><span class="text-white text-3xl">&#10095;</span></button>
  
  <img id="lightbox-img" src="" alt="" class="max-h-full max-w-full rounded-md shadow-lg object-contain transition-all duration-300 ease-out" />
  
  <div id="lightbox-caption" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-black bg-opacity-60 text-white text-sm px-3 py-1 rounded"></div>
</div>

<script type="module">
  let currentGalleryImages = [];
  let currentIndex = 0;

  const lightbox = document.getElementById('lightbox');
  const lbImg = document.getElementById('lightbox-img');
  const lbCaption = document.getElementById('lightbox-caption');
  const btnClose = document.getElementById('lightbox-close');
  const btnPrev = document.getElementById('lightbox-prev');
  const btnNext = document.getElementById('lightbox-next');

  function openLightbox(galleryImgs, index) {
    currentGalleryImages = galleryImgs;
    currentIndex = index;
    lightbox.classList.remove('hidden');
    document.body.classList.add('overflow-hidden');
    updateLightbox();
  }

  function closeLightbox() {
    lightbox.classList.add('hidden');
    document.body.classList.remove('overflow-hidden');
    // Clear src to save memory
    setTimeout(() => { lbImg.src = ''; }, 300);
  }

  function updateLightbox() {
    if (!currentGalleryImages[currentIndex]) return;
    const { fullSrc, placeholder, title } = currentGalleryImages[currentIndex];

    // UI Updates
    lbCaption.textContent = title || '';
    btnPrev.style.display = currentIndex > 0 ? 'block' : 'none';
    btnNext.style.display = currentIndex < currentGalleryImages.length - 1 ? 'block' : 'none';

    // BLUR LOADING LOGIC:
    // If the image is already loaded (src matches), don't blur. 
    // If it's new, show placeholder + blur, then load high res.
    if (lbImg.src !== fullSrc) {
        // 1. Show low-res placeholder immediately
        lbImg.src = placeholder;
        lbImg.style.filter = 'blur(10px)'; 
        
        // 2. Load High Res in background
        const imgLoader = new Image();
        imgLoader.src = fullSrc;
        
        imgLoader.onload = () => {
             // Only switch if the user hasn't navigated away
             if (currentIndex !== -1 && currentGalleryImages[currentIndex].fullSrc === fullSrc) {
                 lbImg.src = fullSrc;
                 lbImg.style.filter = 'none';
             }
        };
    } else {
        lbImg.style.filter = 'none';
    }
  }

  document.addEventListener('click', (e) => {
    const clickedImg = e.target.closest('.gallery img');
    if (!clickedImg) return;
    
    const galleryContainer = clickedImg.closest('.gallery');
    
    // Construct gallery array using currentSrc (the thumbnail) as the placeholder
    const imgs = Array.from(galleryContainer.querySelectorAll('img')).map((el) => ({
      fullSrc: el.dataset.fullSrc || el.src, 
      placeholder: el.currentSrc || el.src,
      title: el.dataset.title || ''
    }));

    openLightbox(imgs, parseInt(clickedImg.dataset.index, 10));
  });

  btnClose.addEventListener('click', closeLightbox);
  btnPrev.addEventListener('click', () => { if (currentIndex > 0) { currentIndex--; updateLightbox(); } });
  btnNext.addEventListener('click', () => { if (currentIndex < currentGalleryImages.length - 1) { currentIndex++; updateLightbox(); } });
  lightbox.addEventListener('click', (e) => { if (e.target === lightbox) closeLightbox(); });
  document.addEventListener('keydown', (e) => {
    if (lightbox.classList.contains('hidden')) return;
    if (e.key === 'Escape') closeLightbox();
    else if (e.key === 'ArrowLeft' && currentIndex > 0) { currentIndex--; updateLightbox(); }
    else if (e.key === 'ArrowRight' && currentIndex < currentGalleryImages.length - 1) { currentIndex++; updateLightbox(); }
  });
</script>

<script>
  // SCROLL & CLAMPING LOGIC (Unchanged)
  function updateScrollIndicators(gallery) {
    if (!gallery) return;
    const scrollContainer = gallery.querySelector('div'); 
    const hasHorizontalOverflow = scrollContainer.scrollWidth > scrollContainer.clientWidth + 1;
    if (hasHorizontalOverflow) {
      gallery.classList.add('is-scrollable-x');
      const isAtEnd = scrollContainer.scrollLeft + scrollContainer.clientWidth >= scrollContainer.scrollWidth - 1;
      gallery.classList.toggle('is-scrolled-to-end-x', isAtEnd);
    } else {
      gallery.classList.remove('is-scrollable-x', 'is-scrolled-to-end-x');
    }

    const hasVerticalOverflow = scrollContainer.scrollHeight > scrollContainer.clientHeight + 1;
    if (hasVerticalOverflow) {
      gallery.classList.add('is-scrollable-y');
      const isAtEnd = scrollContainer.scrollTop + scrollContainer.clientHeight >= scrollContainer.scrollHeight - 1;
      gallery.classList.toggle('is-scrolled-to-end-y', isAtEnd);
    } else {
      gallery.classList.remove('is-scrollable-y', 'is-scrolled-to-end-y');
    }
  }

  function computeTextVideoHeight(textPara, videoIframe) {
    const paraHeight = textPara.getBoundingClientRect().height;
    if (!videoIframe) return paraHeight;
    const videoWidth  = videoIframe.offsetWidth;
    const videoHeight = (videoWidth * 9) / 16;
    return paraHeight + 16 + videoHeight;
  }

  function clampSingleGallery(item) {
    const textPara    = item.querySelector('.timeline-text p');
    const videoIframe = item.querySelector('.timeline-text iframe');
    const gallery     = item.querySelector('.gallery');
    if (!textPara || !gallery) return;
    const imgs = gallery.querySelectorAll('img');

    if (imgs.length === 1 && !videoIframe) {
      gallery.style.maxHeight = 'none';
      const fullHeight = gallery.scrollHeight;
      gallery.style.maxHeight = `${fullHeight}px`;
    }
    else if (videoIframe) {
      const needed = computeTextVideoHeight(textPara, videoIframe);
      const minHeight = gallery.offsetWidth * 0.67;
      gallery.style.maxHeight = `${Math.max(needed, minHeight)}px`;
    }
    else {
      const textHeight = textPara.getBoundingClientRect().height;
      const minHeight = gallery.offsetWidth * 0.67;
      gallery.style.maxHeight = `${Math.max(textHeight, minHeight)}px`;
    }
    gallery.classList.add('clamped');
    updateScrollIndicators(gallery);
  }

  window.addEventListener('load', () => {
    document.querySelectorAll('.timeline-item').forEach(item => {
      const gallery = item.querySelector('.gallery');
      clampSingleGallery(item);
      if (gallery) {
        gallery.querySelector('div').addEventListener('scroll', () => updateScrollIndicators(gallery), { passive: true });
      }
      const textPara = item.querySelector('.timeline-text p');
      if (textPara) new ResizeObserver(() => clampSingleGallery(item)).observe(textPara);
      window.addEventListener('resize', () => clampSingleGallery(item));
    });
  });
</script>

<style>
  .gallery { position: relative; }
  .gallery::after {
    content: ''; position: absolute; z-index: 10; pointer-events: none; opacity: 0; transition: opacity 0.2s ease-in-out;
  }
  .gallery.is-scrollable-x::after {
    top: 0; right: 0; bottom: 0; width: 40px; background: linear-gradient(to left, var(--card-bg), transparent); opacity: 1;
  }
  .gallery.is-scrollable-x.is-scrolled-to-end-x::after { opacity: 0; }
  @media (min-width: 640px) {
    .gallery.is-scrollable-y::after {
      bottom: 0; left: 0; right: 0; height: 40px; background: linear-gradient(to top, var(--card-bg), transparent); opacity: 1;
    }
    .gallery.is-scrollable-y.is-scrolled-to-end-y::after { opacity: 0; }
    .gallery.is-scrollable-x::after { opacity: 0; }
  }
</style>